# Clients Module - Agent Quick Reference

**Folder:** `backend/modules/clients/`
**Purpose:** Client management with firm-scoped multi-tenancy
**Layer:** Domain

## Quick Rules

✅ **Can Do:**
- Create new models with `FirmScopedMixin`
- Add serializers for API
- Create viewsets with `FirmScopedMixin`
- Add migrations for schema changes
- Add client-related utilities
- Update portal functionality

❌ **Cannot Do:**
- Import from other business modules without ADR
- Break firm-scoping
- Depend on business modules (only core/firm allowed)
- Remove firm ForeignKey from models

⚠️ **Requires HITL:**
- Schema changes affecting other modules
- Breaking API changes
- Security-related changes
- Portal access changes

## Patterns

**Model:**
```python
from modules.firm.utils import FirmScopedMixin

class Client(FirmScopedMixin, models.Model):
    firm = models.ForeignKey('firm.Firm', on_delete=models.CASCADE)
    name = models.CharField(max_length=255)
```

**Viewset:**
```python
from modules.firm.utils import FirmScopedMixin

class ClientViewSet(FirmScopedMixin, viewsets.ModelViewSet):
    queryset = Client.objects.all()
    serializer_class = ClientSerializer
```

**Serializer:**
```python
class ClientSerializer(serializers.ModelSerializer):
    class Meta:
        model = Client
        fields = '__all__'
```

## Boundaries

**Can Import From:**
- ✅ `backend/modules/core`
- ✅ `backend/modules/firm`

**Cannot Import From:**
- ❌ `backend/modules/crm` (requires ADR)
- ❌ `backend/modules/finance` (requires ADR)
- ❌ `backend/modules/projects` (requires ADR)

**Used By:**
- `backend/api/clients`
- `frontend/src/api/clients.ts`

## Test Patterns

**Viewset Test:**
```python
import pytest
from rest_framework.test import APIClient
from modules.firm.models import Firm
from modules.clients.models import Client

@pytest.fixture
def api_client(firm, user):
    client = APIClient()
    client.force_authenticate(user=user)
    client.force_authenticate(firm=firm)  # Set request.firm
    return client

def test_client_list(api_client, firm):
    Client.objects.create(firm=firm, name='Test Client')
    response = api_client.get('/api/clients/')
    assert response.status_code == 200
    assert len(response.data['results']) == 1
    assert response.data['results'][0]['name'] == 'Test Client'
```

**Model Test:**
```python
def test_client_firm_scoping(firm):
    client = Client.objects.create(firm=firm, name='Test Client')
    assert client.firm == firm
    assert Client.objects.filter(firm=firm).count() == 1
```

**Serializer Test:**
```python
def test_client_serializer(firm):
    client = Client.objects.create(firm=firm, name='Test Client')
    serializer = ClientSerializer(client)
    assert serializer.data['name'] == 'Test Client'
    assert serializer.data['firm'] == firm.id
```

**Coverage Requirements:**
- Minimum 80% coverage for new code
- All viewsets must have tests
- All serializers must have tests
- Firm-scoping must be tested

## Common Tasks

**Add New Client Field:**
1. Add field to `backend/modules/clients/models/clients.py`
2. Create migration: `python manage.py makemigrations clients`
3. Update `ClientSerializer` in `serializers.py`
4. Add/update tests in `tests/clients/`
5. Run: `pytest tests/clients/ -v --cov=modules.clients`

**Add New Contact Model:**
1. Create model in `backend/modules/clients/models/contacts.py`
2. Inherit from `FirmScopedMixin`
3. Add `firm` ForeignKey
4. Create migration
5. Add serializer
6. Add viewset
7. Add tests (viewset, serializer, model)
8. Verify coverage: `pytest tests/clients/ --cov=modules.clients --cov-report=term-missing`

## Links

- Full guide: `backend/BACKEND.md`
- Policy: `.repo/policy/BOUNDARIES.md`
- JSON context: `.agent-context.json`

---

**Note:** All client data must be firm-scoped. Cross-module imports require ADR.
