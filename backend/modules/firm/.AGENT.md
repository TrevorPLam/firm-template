# Firm Module - Agent Quick Reference

**Folder:** `backend/modules/firm/`
**Purpose:** Multi-tenant foundation - Firm model, FirmMembership, firm context middleware
**Layer:** Platform

## Quick Rules

✅ **Can Do:**
- Add firm-scoped utilities
- Update firm context middleware
- Add firm-related models (with care)
- Update firm scoping helpers

❌ **Cannot Do:**
- Break firm-scoping invariants
- Remove firm context requirement
- Break FirmScopedMixin API
- Depend on business modules

⚠️ **Requires HITL:**
- Changes to Firm model schema
- Changes to firm context resolution
- Breaking changes to FirmScopedMixin
- Security-related changes

## Patterns

**Firm-Scoped Model:**
```python
from modules.firm.utils import FirmScopedMixin

class ModelName(FirmScopedMixin, models.Model):
    firm = models.ForeignKey('firm.Firm', on_delete=models.CASCADE)
```

**Viewset with Firm Scoping:**
```python
from modules.firm.utils import FirmScopedMixin

class ModelViewSet(FirmScopedMixin, viewsets.ModelViewSet):
    queryset = ModelName.objects.all()
    serializer_class = ModelSerializer
```

**Firm-Scoped Query:**
```python
from modules.firm.utils import get_request_firm, firm_scoped_queryset

firm = get_request_firm(request)
queryset = firm_scoped_queryset(ModelName, firm)
```

## Boundaries

**Can Import From:**
- ✅ `backend/modules/core`

**Cannot Import From:**
- ❌ `backend/modules/clients`
- ❌ `backend/modules/crm`
- ❌ `backend/modules/finance`
- ❌ Any business modules

**Used By:**
- All business modules depend on firm

## Common Tasks

**Add Firm-Scoped Model:**
1. Inherit from `FirmScopedMixin` and `models.Model`
2. Add `firm` ForeignKey
3. Create migration: `python manage.py makemigrations firm`
4. Add serializer
5. Add viewset with `FirmScopedMixin`
6. Add tests

## Links

- Full guide: `backend/modules/firm/README.md`
- Policy: `.repo/policy/BOUNDARIES.md`
- JSON context: `.agent-context.json`

---

**Note:** Firm is the multi-tenant foundation. All business data must be firm-scoped.
