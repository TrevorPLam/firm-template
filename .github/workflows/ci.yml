name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Test
        run: pnpm test -- --coverage

      - name: Enforce coverage thresholds
        env:
          COVERAGE_MIN_LINES: 70
        run: node scripts/ci/check-coverage.js

      - name: Build
        run: pnpm build

      - name: Prepare artifacts
        run: ./scripts/ci/prepare-artifacts.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: artifacts

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency review
        uses: actions/dependency-review-action@v4

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit production dependencies
        run: pnpm audit --audit-level=high

      - name: Run security checks
        run: |
          echo "Running security scans..."
          # Check for hardcoded secrets and sensitive data
          if [ -f "scripts/security/check-secrets.sh" ]; then
            ./scripts/security/check-secrets.sh
          fi
          # Check protected paths haven't been modified
          if [ -f "scripts/security/check-protected-paths.sh" ]; then
            ./scripts/security/check-protected-paths.sh
          fi
