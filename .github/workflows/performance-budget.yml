name: Performance Budget

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  performance-budget:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Check bundle size
        run: npm run check:bundle-size

      - name: Analyze bundle
        run: npm run analyze:json > bundle-analysis.json || true

      - name: Check performance budget
        run: |
          node -e "
          const fs = require('fs');
          const analysis = JSON.parse(fs.readFileSync('bundle-analysis.json', 'utf8'));
          const budgets = {
            'first-contentful-paint': 2000,
            'largest-contentful-paint': 2500,
            'total-blocking-time': 300,
            'cumulative-layout-shift': 0.1,
            'bundle-size': 500000
          };
          let failed = false;
          for (const [metric, budget] of Object.entries(budgets)) {
            if (analysis[metric] && analysis[metric] > budget) {
              console.error(\`❌ \${metric}: \${analysis[metric]} exceeds budget of \${budget}\`);
              failed = true;
            } else {
              console.log(\`✅ \${metric}: \${analysis[metric] || 'N/A'} (budget: \${budget})\`);
            }
          }
          process.exit(failed ? 1 : 0);
          " || true
